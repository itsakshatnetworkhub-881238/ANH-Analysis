<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ANH Sign Up</title>

<style>
:root{
  --bg:#0f172a;
  --card:#1e293b;
  --accent:#2563eb;
  --accent-light:#3b82f6;
  --success:#16a34a;
  --warning:#f59e0b;
  --danger:#dc2626;
  --text:#f1f5f9;
}

body{
  margin:0;
  font-family:system-ui;
  background:linear-gradient(135deg,#0f172a,#1e293b);
  color:var(--text);
  display:flex;
  justify-content:center;
  align-items:center;
  padding:20px;
}

.card{
  background:var(--card);
  padding:30px;
  border-radius:14px;
  width:100%;
  max-width:500px;
  box-shadow:0 15px 40px rgba(0,0,0,.5);
}

input, select{
  width:100%;
  padding:10px;
  margin-bottom:10px;
  border-radius:6px;
  border:1px solid #334155;
  background:#0f172a;
  color:white;
}

button{
  width:100%;
  padding:12px;
  border:none;
  border-radius:8px;
  background:var(--accent);
  color:white;
  font-weight:bold;
  cursor:pointer;
}

#strengthBar{
  height:6px;
  border-radius:6px;
  margin-bottom:10px;
  background:var(--danger);
}
</style>
</head>
<body>

<div class="card">
<h2>Create Akshat Network Hub Account</h2>

<input type="email" id="email" placeholder="Email" required>
<input type="text" id="name" placeholder="Full Name" required>
<input type="text" id="username" placeholder="Username" required>
<input type="date" id="dob" required>

<input type="password" id="password" placeholder="Password" oninput="checkStrength()">
<div id="strengthBar"></div>

<input type="password" id="confirmPassword" placeholder="Confirm Password">

<h4>Select Any 3 Recovery Questions</h4>

<select class="recovery"></select>
<input type="text" class="answer" placeholder="Answer">

<select class="recovery"></select>
<input type="text" class="answer" placeholder="Answer">

<select class="recovery"></select>
<input type="text" class="answer" placeholder="Answer">

<label>
<input type="checkbox" id="privacy">
 I agree to store data locally (IndexedDB)
</label>

<button onclick="register()">Register</button>
</div>

<script>
/* ===== DATABASE ===== */
const DB_NAME="ANH_DB";
let db;

const request=indexedDB.open(DB_NAME,1);
request.onupgradeneeded=e=>{
  db=e.target.result;
  db.createObjectStore("users",{keyPath:"email"});
};
request.onsuccess=e=>db=e.target.result;

/* ===== RECOVERY QUESTIONS POOL ===== */
const questions=[
"Father Name",
"Mother Name",
"Favorite Color",
"Favorite Actor",
"Favorite Sport",
"Lucky Number",
"Birth City",
"Best Friend Name"
];

document.querySelectorAll(".recovery").forEach(select=>{
  select.innerHTML="<option value=''>Select Question</option>";
  questions.forEach(q=>{
    select.innerHTML+=`<option>${q}</option>`;
  });
});

/* ===== AGE CHECK ===== */
function validAge(dob){
  const birth=new Date(dob);
  const today=new Date();
  let age=today.getFullYear()-birth.getFullYear();
  const m=today.getMonth()-birth.getMonth();
  if(m<0 || (m===0 && today.getDate()<birth.getDate())){
    age--;
  }
  return age>=12;
}

/* ===== PASSWORD STRENGTH ===== */
function checkStrength(){
  const pass=document.getElementById("password").value;
  const bar=document.getElementById("strengthBar");

  if(pass.length<8){
    bar.style.background="#dc2626";
  }
  else if(/[A-Z]/.test(pass)&&/[0-9]/.test(pass)){
    bar.style.background="#f59e0b";
  }
  if(/[A-Z]/.test(pass)&&/[0-9]/.test(pass)&&/[@$!%*?&]/.test(pass)){
    bar.style.background="#16a34a";
  }
}

/* ===== ANH HASH ===== */
function generateANHHash(password){
  const ascii=password.split('').map(c=>c.charCodeAt(0)).join('');
  const seq=['anh','nah','han','nha'];
  let result='',ptr=0;

  for(let i=0;i<ascii.length;i+=6){
    result+=ascii.substring(i,i+6);
    if(i+6<ascii.length){
      result+=seq[ptr];
      ptr=(ptr+1)%seq.length;
    }
  }
  return result;
}

/* ===== CHECK PASSWORD UNIQUE ===== */
function isPasswordUsed(hash){
  return new Promise(resolve=>{
    const tx=db.transaction("users","readonly");
    const store=tx.objectStore("users");
    const req=store.getAll();
    req.onsuccess=()=>{
      resolve(req.result.some(u=>u.password===hash));
    };
  });
}

/* ===== REGISTER ===== */
async function register(){

  if(!db){
    alert("Database not ready. Try again.");
    return;
  }

  const email=document.getElementById("email").value.trim();
  const name=document.getElementById("name").value.trim();
  const username=document.getElementById("username").value.trim();
  const dob=document.getElementById("dob").value;
  const password=document.getElementById("password").value;
  const confirmPassword=document.getElementById("confirmPassword").value;
  const privacy=document.getElementById("privacy").checked;

  if(!email||!name||!username||!dob||!password||!confirmPassword){
    alert("Please fill all fields");
    return;
  }

  if(!privacy){
    alert("Accept privacy policy");
    return;
  }

  if(!validAge(dob)){
    alert("Minimum age is 12");
    return;
  }

  if(password!==confirmPassword){
    alert("Passwords do not match");
    return;
  }

  const strong=password.length>=8 &&
    /[A-Z]/.test(password) &&
    /[0-9]/.test(password) &&
    /[@$!%*?&]/.test(password);

  if(!strong){
    alert("Password must be strong");
    return;
  }

  const hash=generateANHHash(password);

  if(await isPasswordUsed(hash)){
    alert("Password already used");
    return;
  }

  /* Recovery Validation */
  const selects=document.querySelectorAll(".recovery");
  const answers=document.querySelectorAll(".answer");
  let recovery=[];
  let chosen=[];

  for(let i=0;i<selects.length;i++){
    const q=selects[i].value;
    const a=answers[i].value.trim();

    if(!q||!a){
      alert("Fill all recovery questions");
      return;
    }

    if(chosen.includes(q)){
      alert("Recovery questions must be unique");
      return;
    }

    chosen.push(q);
    recovery.push({q,a});
  }

  const tx=db.transaction("users","readwrite");
  const store=tx.objectStore("users");

  store.add({
    email,
    name,
    username,
    dob,
    password:hash,
    recovery
  });

  alert("Account Created Successfully");
  window.location.href="login.htm";
}
</script>

</body>
</html>
