<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ANH Password Recovery</title>

<style>
:root{
  --bg:#0f172a;
  --card:#1e293b;
  --accent:#2563eb;
  --accent-light:#3b82f6;
  --danger:#dc2626;
  --success:#16a34a;
  --text:#f1f5f9;
}

body{
  margin:0;
  font-family:system-ui, -apple-system, sans-serif;
  background:linear-gradient(135deg,#0f172a,#1e293b);
  color:var(--text);
  display:flex;
  justify-content:center;
  align-items:center;
  padding:20px;
}

.card{
  background:var(--card);
  padding:30px;
  border-radius:14px;
  width:100%;
  max-width:500px;
  box-shadow:0 15px 40px rgba(0,0,0,.5);
  transition:.3s;
}

.card:hover{
  transform:translateY(-3px);
}

h2{text-align:center;margin-bottom:20px;}

input{
  width:100%;
  padding:12px;
  margin:8px 0;
  border-radius:8px;
  border:1px solid #334155;
  background:#0f172a;
  color:white;
  transition:.3s;
}

input:focus{
  border-color:var(--accent);
  outline:none;
  box-shadow:0 0 10px rgba(37,99,235,.4);
}

button{
  width:100%;
  padding:12px;
  border:none;
  border-radius:8px;
  background:var(--accent);
  color:white;
  font-weight:bold;
  cursor:pointer;
  margin-top:10px;
  transition:.3s;
}

button:hover{
  background:var(--accent-light);
}

.status{
  margin-top:10px;
  text-align:center;
  font-size:14px;
}

.hidden{display:none;}

#strengthBar{
  height:6px;
  border-radius:6px;
  background:var(--danger);
  margin-top:4px;
  transition:.3s;
}

@media (min-width:768px){
  .card{max-width:550px;}
}
</style>
</head>
<body>

<div class="card">

<h2>Recover Your Akshat Network Hub Account</h2>

<div id="step1">
<input type="email" id="email" placeholder="Enter Registered Email">
<button onclick="verifyUser()">Verify Account</button>
</div>

<div id="step2" class="hidden">
<h4>Answer Any 3 Recovery Questions</h4>
<div id="questions"></div>
<button onclick="validateRecovery()">Validate Answers</button>
</div>

<div id="step3" class="hidden">
<h4>Set New Password</h4>
<input type="password" id="newPassword" placeholder="New Password" oninput="checkStrength()">
<div id="strengthBar"></div>
<input type="password" id="confirmPassword" placeholder="Confirm New Password">
<button onclick="resetPassword()">Reset Password</button>
</div>

<div class="status" id="status"></div>

<p style="text-align:center;margin-top:15px;">
<a href="login.htm" style="color:#3b82f6;">Back to Login</a>
</p>

</div>

<script>

const DB_NAME="ANH_DB";
let db,currentUser=null;

const req=indexedDB.open(DB_NAME,1);
req.onupgradeneeded=e=>{
  db=e.target.result;
  if(!db.objectStoreNames.contains("users")){
    db.createObjectStore("users",{keyPath:"email"});
  }
};
req.onsuccess=e=>{db=e.target.result};

/* ===== HASH ===== */
function generateANHHash(password){
  const ascii=password.split('').map(c=>c.charCodeAt(0)).join('');
  const seq=['anh','nah','han','nha'];
  let result='',ptr=0;

  for(let i=0;i<ascii.length;i+=6){
    result+=ascii.substring(i,i+6);
    if(i+6<ascii.length){
      result+=seq[ptr];
      ptr=(ptr+1)%seq.length;
    }
  }
  return result;
}

/* ===== PASSWORD STRENGTH ===== */
function checkStrength(){
  const pass=newPassword.value;
  if(pass.length<8) strengthBar.style.background="#dc2626";
  else if(/[A-Z]/.test(pass)&&/[0-9]/.test(pass)) strengthBar.style.background="#f59e0b";
  else if(/[A-Z]/.test(pass)&&/[0-9]/.test(pass)&&/[@$!%*?&]/.test(pass))
    strengthBar.style.background="#16a34a";
}

/* ===== STEP 1 ===== */
function verifyUser(){
  const tx=db.transaction("users","readonly");
  const store=tx.objectStore("users");
  const request=store.get(email.value.trim());

  request.onsuccess=function(){
    if(!request.result){
      status.innerHTML="<span style='color:red;'>Account not found.</span>";
      return;
    }

    currentUser=request.result;
    loadQuestions();
    step1.classList.add("hidden");
    step2.classList.remove("hidden");
  };
}

/* ===== LOAD QUESTIONS ===== */
function loadQuestions(){
  questions.innerHTML="";
  currentUser.recovery.forEach((item,index)=>{
    questions.innerHTML+=`
      <input type="text" id="ans${index}" placeholder="${item.q}">
    `;
  });
}

/* ===== STEP 2 ===== */
function validateRecovery(){

  let correct=0;

  currentUser.recovery.forEach((item,index)=>{
    const userAns=document.getElementById("ans"+index).value.trim();
    if(userAns.toLowerCase()===item.a.toLowerCase()){
      correct++;
    }
  });

  if(correct>=3){
    step2.classList.add("hidden");
    step3.classList.remove("hidden");
  }else{
    status.innerHTML="<span style='color:red;'>Minimum 3 correct answers required.</span>";
  }
}

/* ===== STEP 3 ===== */
function resetPassword(){

  if(newPassword.value!==confirmPassword.value){
    status.innerHTML="<span style='color:red;'>Passwords do not match.</span>";
    return;
  }

  const strong=newPassword.value.length>=8 &&
    /[A-Z]/.test(newPassword.value) &&
    /[0-9]/.test(newPassword.value) &&
    /[@$!%*?&]/.test(newPassword.value);

  if(!strong){
    status.innerHTML="<span style='color:red;'>Password not strong enough.</span>";
    return;
  }

  const newHash=generateANHHash(newPassword.value);

  if(newHash===currentUser.password){
    status.innerHTML="<span style='color:red;'>Cannot reuse previous password.</span>";
    return;
  }

  const tx=db.transaction("users","readwrite");
  const store=tx.objectStore("users");
  currentUser.password=newHash;
  store.put(currentUser);

  status.innerHTML="<span style='color:green;'>Password Reset Successful.</span>";

  setTimeout(()=>{
    window.location.href="login.htm";
  },1500);
}

</script>

</body>
</html>
